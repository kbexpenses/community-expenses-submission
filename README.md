# community-expenses-submission

Community projects often handle reimbursement of expenses. This process can
be labour intensive. The goal of this software is to make this process
easier, and allow more people to share the work. We're inspired by the
[opencollective](https://opencollective.com/) system.

## Stack

- Auth0
  - User registration and login is handled via Auth0
  - Auth0 provides a JWT to the user on successful login
- Hasura backend
  - The backend is a hasura server
  - It exposes a postgres database via GraphQL
  - The configuration is in the `hasura/` folder
  - Hasura takes user data from the JWT generated by Auth0
- Media server
  - Images are uploaded to and served from a dedicated media server
  - It (currently) puts files on disk
  - The media server enforces permissions
- React frontend
  - Using redux (minimally)
  - Apollo is the GraphQL client connecting to Hasura
  - The Auth0-lock package is used to handle authentication
    - The JWT is written into `localStorage` on successful login

### Services

The stack can be deployed with the following services:

- [Auth0](https://auth0.com/) for user management
  - See the Hasura docs on how to link Auth0 and Hasura
- [Heroku](https://www.heroku.com/) for the hasura server
  - Should fit comfortably within their free dyno limit
- [Netlify](https://www.netlify.com/) for the static frontend
  - Netlify offers free static site hosting and will build from GitHub automatically

## Development

To run this locally in development you need the following installed:

- [nodejs](https://nodejs.org/)
- [yarn](https://www.yarnpkg.com/)
- [docker](https://www.docker.com)
  - Including `docker-compose`

You'll need multiple terminals to run all the pieces. More info below.

### Config

To run the app in development, you'll need some config values. They're
included in this repo in `.env` at the root. However, to standardise on this,
we're planning to copy the config setup from
[here](https://github.com/chmac/community-shift-signup). See
https://github.com/chmac/community-expenses-submission/issues/4.

### Data backend

Hasura requires 2 terminals. Firstly, to run the Hasura engine:

- `cd hasura`
- `docker-compose up`

  - This starts the Hasura engine via docker

Now in a second terminal:

- `cd hasura`
- `yarn`
- `yarn run migrate:status`
  - This will tell you the hasura console migration status
- `yarn run migrate:apply`
  - This will ensure you are running the latest migrations
- `yarn start`
  - This starts the Hasura console

Then you need to add some data to be able to use the app. As a minimum:

- Insert 2 budget categories
  - http://localhost:9695/data/schema/public/tables/budget_categories/insert
  - Pick any name you like
  - Enter a budget amount in cents (so `20000` = â‚¬200)

### Media server

- `cd media-server`
- `yarn`
- `yarn start`

### Frontend

- `cd frontend`
- `yarn`
- `yarn start`

## Demo

You can login with email `admin@mailinator.com` and password `pass123!`.

Or if you create our own Auth0 setup, for admin users, set their app_metadata to:

```json
{
  "roles": ["user", "admin"]
}
```

## Deployment

To deploy this application requires the following.

- Setup an Auth0 account and fill the config values into .env
  - NOTE: The .env setup needs to be fixed for this to work 100% see #4
  - Copy the JWT secret into the root `.env` file
- Deploy hasura
  - Easiest is likely via docker, which requires 2 containers, a postgres
    container and the hasura container itself
  - Copy the hasura secret key to the root `.env`
  - Run the hasura migrations against this server
    - The migration files are in the `hasura/` folder
    - There are migration commands above that might help understanding this
      part
    - TODO Provide better docs on how to do this
    - https://hasura.io/docs/1.0/graphql/core/deployment/deployment-guides/docker.html#deployment-docker
- Deploy an HTTPS termination service in front of hasura
  - The easiest is probably another docker container
  - https://hasura.io/docs/1.0/graphql/core/deployment/enable-https.html#enable-https
  - Copy the public hasura URL into the root `.env`
- Deploy the media server
  - This is a simple node script, it could be packaged to run inside a docker
    container
- Deploy an HTTPS termination service in front of the media server
  - Likely using the same strategy as for Hasura
- Build and deploy the frontend
  - Set the frontend URL into `.env`
  - This is most easily done via netlify
  - If you want to do this manually, the steps are loosely:
    - Install all dependencies in `frontend/` like `cd frontend && yarn`
    - Build the frontend `cd frontend && yarn build`
    - Serve the `build/` folder at a URL with HTTPS enabled
      - It's purely static files, so any web server or CDN will do
  - PRs adding a multi stage docker build for this part most welcome

## User Testing

- Erin Jeavons-Fellows - Chief User Tester (President)
